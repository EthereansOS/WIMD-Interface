"use strict";function _typeof(e){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?_typeof=function(t){return typeof t}:_typeof=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(e)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){function o(e,t){try{var n=s[e](t),o=n.value}catch(f){i(f);return}n.done?r(o):Promise.resolve(o).then(u,a)}function u(e){o("next",e)}function a(e){o("throw",e)}var s=e.apply(t,n);u()})}}(window.preloadedScripts=window.preloadedScripts||[]).push(...['spa/farming/controller.js','spa/farming/style.min.css','spa/farming/view.jsx','spa/index/cardCraftSelector.jsx','spa/index/cardInfo.jsx','spa/index/controller.js','spa/index/style.min.css','spa/index/view.jsx','spa/inlineLoader.jsx','spa/redeem/controller.js','spa/redeem/style.min.css','spa/redeem/view.jsx']);var FarmingController = function (view) {
    var context = this;
    context.view = view;

    context.loadData = async function loadData() {
        context.loadItems();
        context.loadStakingData();
    };

    context.loadItems = async function loadItems() {
        var items = [];
        for(var i = 0; i < context.view.props.sortedItems.length; i++) {
            var item = context.view.props.sortedItems[i];
            var stateItem = {
                item
            };
            stateItem.priceInDollars = await window.getTokenPriceInDollarsOnUniswap(item.erc20Wrapper, 18);
            items.push(stateItem);
        }
        context.view.setState({items});
    };

    context.loadStakingData = async function loadStakingData() {
        var stakingContracts = await window.AJAXRequest('data/stakingContracts.json');
        var periods = Object.values(stakingContracts);
        for(var period of periods) {
            var items = Object.values(period);
            for(var item of items) {
                item.stakingData = await window.loadStakingData(item.stakingAddresses);
            }
        }
        context.view.setState({stakingContracts});
    };
};var Farming=React.createClass({displayName:"Farming",requiredScripts:["spa/index/cardInfo.jsx","spa/inlineLoader.jsx"],componentDidMount:function(){this.controller.loadData()},getFirstEndBlock:function(t){var n=Object.values(t);for(var r=0;r<n.length;r++){var i=n[r];if(i.stakingData&&i.stakingData.stakingData&&i.stakingData.stakingData.length>0)return i.stakingData.stakingData[0].endBlock}},render:function(){var t=this,n=this;return React.createElement("section",null,React.createElement("section",{className:"FarmingTop"},React.createElement("h2",{className:"BrandizedS"},"Cards"),this.props.sortedItems.map(function(e,n){return React.createElement("section",{key:e.key,className:"collection CardsBigview"},React.createElement(CardInfo,{card:e,clean:!0,hideBalance:!0}),React.createElement("div",{className:"CardsBigviewInfo"},t.state&&t.state.items&&t.state.items[n]&&React.createElement("p",{className:"UniPriceBro"},"$ ",window.formatMoney(t.state.items[n].priceInDollars,1)),React.createElement("a",{className:"unibtn",href:window.context.uniSwapInfoURL.format(e.erc20Wrapper),target:"_blank"},"Liquidity"),React.createElement("a",{className:"unibtn",href:window.context.uniswapSpawUrlTemplate.format(e.erc20Wrapper),target:"_blank"},"Swap"),React.createElement("a",{className:"unibtn Opns",href:window.context.openSeaItemLinkTemplate.format(window.whereIsMyDragonEthItem.options.address,e.key),target:"_blank"},"OpenSea"),React.createElement("a",{className:"unibtn",href:window.context.ethItemLinkTemplate.format(e.erc20Wrapper),target:"_blank"},"Info")))}),React.createElement("section",{className:"Delimitator"}),React.createElement("h2",{className:"BrandizedS"},"Decks"),React.createElement("section",{className:"collection DeckBigview"},React.createElement("section",{className:"singleCollCard cardInfo"},React.createElement("figure",{className:"collCard"},React.createElement("img",{src:"//ipfs.io/ipfs/QmbUYRhM8TKGm7iD9mLgSVC5fcToeXaDdk8ntz6yDMJnp1"}))),React.createElement("div",{className:"CardsBigviewInfoP"},React.createElement("p",null,'A collection of the four common cards of the ITEMS based card game "Where Is My Dragon". Each unit of this deck contains 1 Penguin Fancy Shoes, 1 Unicorn Cat, 1 Magician Unicorn and 1 Magician Cat')),React.createElement("div",{className:"CardsBigviewInfo"},React.createElement("a",{className:"unibtn",href:"https://v2.info.uniswap.org/token/0xD15c7Fcda27a93b9d4cD3617E09416Ec3aaA5237",target:"_blank"},"Liquidity"),React.createElement("a",{className:"unibtn",href:"https://swap.item.eth.link/#/swap?outputCurrency=0xD15c7Fcda27a93b9d4cD3617E09416Ec3aaA5237",target:"_blank"},"Swap"),React.createElement("a",{className:"unibtn Opns",href:"https://opensea.io/assets/0x5a6EdeeE783A17AFa9e40f6a03B6C93Fabc5AdC1/1195241872894617222008635817406839094575782056503",target:"_blank"},"OpenSea"),React.createElement("a",{className:"unibtn",href:"https://item.eth.link/?interoperable=0xD15c7Fcda27a93b9d4cD3617E09416Ec3aaA5237",target:"_blank"},"Info"))),React.createElement("section",{className:"Delimitator"}),React.createElement("h2",{className:"BrandizedS"},"Farming"),React.createElement("section",{className:"FarmSection"},React.createElement("h1",null,"WIMD Last farming season coming soon..."))))}});var CardCraftSelector=React.createClass({displayName:"CardCraftSelector",requiredScripts:["spa/index/cardInfo.jsx"],openSelection:function(t){window.preventItem(t),this.oldValue=this.input.value,this.setState({selecting:!0})},selectCard:function(t,n){var r=this;window.preventItem(t);if(!n&&t.relatedTarget&&$(t.relatedTarget).findReactComponent()===this){var i=parseInt(t.relatedTarget.dataset.index);n=this.props.items.filter(function(e){return e.index===i})[0]}n&&(!n.userData||!n.userData.balanceOf||n.userData.balanceOf==="0");var s={selecting:!1},o=this.state&&this.state.selected;n&&(s.selected=n);var u=this;this.setState(s,function(){u.input.value=!r.oldValue||isNaN(parseInt(r.oldValue))?"4":r.oldValue,delete u.oldValue,o!==n&&u.callOnUpdate()})},onKeyUp:function(t){window.preventItem(t),this.onKeyUpTiemoutId&&window.clearTimeout(this.onKeyUpTiemoutId),this.onKeyUpTiemoutId=window.setTimeout(this.callOnUpdate,window.context.keyUpTimeoutInterval)},callOnUpdate:function(){var t=this;this.highlight();var n=parseInt(this.input&&this.input.value);n=isNaN(n)?0:n;var r=this.state&&this.state.selected,i=this;r&&setTimeout(function(){return i.props.onUpdate(t,{card:r,amount:n})})},highlight:function e(){if(!this.state||!this.state.selected)return $(this.input).removeClass("highlight");var t=parseInt(this.input&&this.input.value);t=isNaN(t)?0:t;var e=window.context.highlightValues.indexOf(t)!==-1;e&&$(this.input).addClass("highlight"),!e&&$(this.input).removeClass("highlight")},renderSelection:function(){var t=this,n=this.props.items,r=this.props.exceptFor||[],i=this.state&&this.state.selected;return r=r.filter(function(e){return e!==undefined&&e!==null&&e.card!==i}).map(function(e){return e.card}),n=n.filter(function(e){return r.indexOf(e)===-1}),React.createElement("section",{className:"cardSelector",tabIndex:"-1",ref:function(t){return t&&t.focus()},onBlur:t.selectCard},React.createElement("ul",null,n.map(function(e){return React.createElement("li",{key:e.key},t.renderCardToClick(e,function(n){return t.selectCard(n,e)},"cardOnSelectionView"))})))},onClick:function(t,n){if(this.props.readOnly)return;n(t)},renderCardToClick:function(t,n,r){var i=this;return React.createElement("a",{href:"javascript:;",className:r+(this.props.readOnly?" disabled":""),"data-index":t.index,onClick:function(t){return i.onClick(t,n)}},React.createElement(CardInfo,{card:t,hideBalance:!0}))},render:function(){var t=this;return this.state&&this.state.selecting?this.renderSelection():React.createElement("section",{className:"craftSingle"},this.state&&this.state.selected&&this.renderCardToClick(this.state.selected,this.openSelection,"cardSelectedView"),(!this.state||!this.state.selected)&&React.createElement("a",{href:"javascript:;",className:"SELECTUM"+(this.props.readOnly?" disabled":""),onClick:this.openSelection},"SELECT"),React.createElement("input",{ref:function(n){return t.input=n},type:"number",className:"cardQuantity",onKeyUp:this.onKeyUp,onChange:this.onKeyUp,readOnly:this.props.readOnly||!this.state||!this.state.selected}))}});var CardInfo=React.createClass({displayName:"CardInfo",requiredScripts:["spa/inlineLoader.jsx"],render:function(){if(!this.props.card.metadata)return React.createElement(InlineLoader,null);var t=!this.props.clean&&(!this.props.card.userData||!this.props.card.userData.balanceOf||this.props.card.userData.balanceOf==="0"),n=!t&&!this.props.hideBalance;return React.createElement("section",{className:"singleCollCard"+(t?" blur":"")},React.createElement("figure",{className:"collCard"},React.createElement("img",{src:this.props.card.staticImage})),n&&React.createElement("span",{className:"cardOwnedNumber Brandized"},this.props.card.userData.balanceOf))}});var IndexController = function (view) {
    var context = this;
    context.view = view;

    context.mintEvent = "Mint(uint256,address,uint256)";

    context.loadAddressBarParam = function loadAddressBarParam() {
        var toggle = window.addressBarParams.toggle;
        delete window.addressBarParams.toggle;
        toggle && context.view.setState({toggle});
    };

    context.loadData = async function loadData() {
        context.view.setState({collectionName : null, items : null});
        window.whereIsMyDragonEthItem = await window.newContract(window.context.IEthItemABI, window.getNetworkElement("whereIsMyDragonEthItemAddress"));
        var collectionName = (await window.blockchainCall(window.whereIsMyDragonEthItem.methods.name)).toLowerCase().split(' ').join('-');
        var logs = await window.getLogs({
            address : window.whereIsMyDragonEthItem.options.address,
            topics : [window.web3.utils.sha3(context.mintEvent)]
        });
        var items = [];
        for(var log of logs) {
            var data = window.web3.eth.abi.decodeParameters(["uint256","address","uint256"], log.data);
            var item = {
                index : items.length,
                key: data[0],
                objectId : data[0],
                erc20Wrapper : data[1]
            }
            items.push(item);
        }
        context.view.setState({collectionName, items}, context.refreshData);
    };

    context.refreshData = async function refreshData() {
        if(!context.view || !context.view.mounted || !context.view.state || !context.view.state.items || context.view.state.items.length === 0) {
            return;
        }
        context.view.state.items.forEach(async (item) => {
            item.metadataLink = item.metadataLink || await window.blockchainCall(window.whereIsMyDragonEthItem.methods.uri, item.objectId);
            item.metadata = item.metadata || await window.AJAXRequest(window.formatLink(item.metadataLink));
            item.staticImage = "assets/img/cardImages/" + item.objectId + ".png";
            item.userData = {
                balanceOf : await window.blockchainCall(window.whereIsMyDragonEthItem.methods.balanceOf, window.walletAddress, item.objectId)
            };
            context.view.setState({items : context.view.state.items});
        });
    };

    context.performCraft = async function performCraft() {
        await window.sleep(window.context.keyUpTimeoutInterval + 100);
        var selections = context.view.state.selections;
        if(selections.filter(it => !it).length > 0) {
            throw "You must select three cards to perform craft";
        }
        if(selections.filter(it => it.amount <= 0).length > 0) {
            throw "Each card must contain a positive amount";
        }
        for(var selection of selections) {
            if(!selection.card.userData || !selection.card.userData.balanceOf || parseInt(selection.card.userData.balanceOf) < selection.amount) {
                throw `You have insufficient ${selection.card.metadata.name}`;
            }
        }
        var from = window.walletAddress;
        var to = window.getNetworkElement("whereIsMyDragonCraftAddress");
        var objectIds = selections.map(it => it.card.objectId);
        var amounts = selections.map(it => it.amount + "");
        try {
            await window.blockchainCall(window.whereIsMyDragonEthItem.methods.safeBatchTransferFrom, from, to, objectIds, amounts, "0x");
            context.refreshData();
        } catch(e) {
            if((e.message || e).toLowerCase().indexOf("user denied") !== -1) {
                return;
            }
            throw 'Something went wrong. Maybe uncorrect crafting?';
        }
    };
};;var Index=React.createClass({displayName:"Index",getDefaultSubscriptions:function(){return{"ethereum/update":this.controller.loadData,"ethereum/ping":this.controller.refreshData}},requiredScripts:["spa/inlineLoader.jsx","spa/index/cardCraftSelector.jsx","spa/index/cardInfo.jsx"],requiredModules:["spa/farming","spa/redeem"],componentDidMount:function(){this.controller.loadAddressBarParam(),this.controller.loadData()},toggleFarming:function(t){t&&t.preventDefault&&t.preventDefault(!0)&&t.stopPropagation&&t.stopPropagation(!0);var n=this.state&&this.state.toggle;this.setState({toggle:n==="farming"?null:"farming"})},toggleRedeem:function(t){t&&t.preventDefault&&t.preventDefault(!0)&&t.stopPropagation&&t.stopPropagation(!0);var n=this.state&&this.state.toggle;this.setState({toggle:n==="redeem"?null:"redeem"})},perform:function(t){t&&t.preventDefault&&t.preventDefault(!0)&&t.stopPropagation&&t.stopPropagation(!0);var n=t.currentTarget;if(this.state&&this.state.performing||n.className.toLowerCase().indexOf("disabled")!==-1)return;var r=n.dataset.action,i=[];for(var s=1;s<arguments.length;s++)i.push(arguments[s]);var o=this,u=function(t){var n=t&&(t.message||t);o.setState({performing:null},function(){n&&n.indexOf("denied")===-1&&setTimeout(function(){alert(n)}),!n&&o.controller.refreshData()})};o.setState({performing:r},function(){o.controller["perform"+r.firstLetterToUpperCase()].apply(this,i).catch(u).finally(u)})},onCardSelectionUpdate:function(t,n){var r=this.state.selections||[null,null,null];r[t.props.index]=n,this.setState({selections:r})},sortItems:function(){if(this.state.items.filter(function(e){return!e.metadata}).length>0)return this.state.items;var t={};for(var n=this.state.items,r=Array.isArray(n),i=0,n=r?n:n[Symbol.iterator]();;){var s;if(r){if(i>=n.length)break;s=n[i++]}else{i=n.next();if(i.done)break;s=i.value}var o=s,u=o.metadata.attributes.filter(function(e){return e.trait_type==="Rarity"})[0].value;t[u]=t[u]||[],t[u].push(o)}var a=[];for(var f=window.context.rarityOrder,l=Array.isArray(f),c=0,f=l?f:f[Symbol.iterator]();;){var h;if(l){if(c>=f.length)break;h=f[c++]}else{c=f.next();if(c.done)break;h=c.value}var u=h;a.push.apply(a,t[u])}return a},getSelectableItems:function(t){var n=[];for(var r=t,i=Array.isArray(r),s=0,r=i?r:r[Symbol.iterator]();;){var o;if(i){if(s>=r.length)break;o=r[s++]}else{s=r.next();if(s.done)break;o=s.value}var u=o;if(!u.userData||!u.userData.balanceOf||u.userData.balanceOf==="0")continue;n.push(u)}var a=t;return a=a.filter(function(e){return window.context.unselectable.indexOf(e.objectId)===-1}),a},render:function(){var t={};this.props&&Object.entries(this.props).forEach(function(e){return t[e[0]]=e[1]}),this.state&&Object.entries(this.state).forEach(function(e){return t[e[0]]=e[1]}),t.props&&Object.entries(t.props).forEach(function(e){return t[e[0]]=e[1]}),delete t.props;var n=t.items&&this.sortItems(),r=n&&this.getSelectableItems(n);return React.createElement("section",{className:this.state&&this.state.toggle?"ALL2":"ALL"},React.createElement("header",null,React.createElement("a",{target:"_blank",href:"/",className:"brand"},React.createElement("img",{src:"assets/img/logo.png"})),React.createElement("a",{target:"_blank",href:"https://ethos.eth.link/wimd.html",className:"navLink BrandizedS"},"Rules"),t.items&&t.items.length>0&&React.createElement("a",{className:"navLink BrandizedS SPECIALITY",href:"javascript:;",onClick:this.toggleFarming},"Swap, Buy & Farm Cards"),window.ethereum&&!window.walletAddress&&React.createElement("a",{className:"connect Brandized",href:"javascript:;",onClick:function(){return window.ethereum.enable()}},"Connect"),React.createElement("a",{target:"_blank",href:"https://etherscan.io/tokenHoldings?a=0x32c87193C2cC9961F2283FcA3ca11A483d8E426B",className:"navThings BrandizedS"},"Treasure: ",window.formatMoney(window.balanceOf,1)," ETH"),t.items&&t.items.length>0&&React.createElement("a",{className:"navLink BrandizedS SPECIALITY",href:"javascript:;",onClick:this.toggleRedeem},"Redeem"),window.walletAddress&&React.createElement("a",{className:"connect BrandizedS",target:"_blank",href:window.getNetworkElement("etherscanURL")+"address/"+window.walletAddress},window.shortenWord(window.walletAddress,15))),(!t.items||t.items.length===0)&&React.createElement(InlineLoader,null),t.items&&t.items.length>0&&React.createElement("section",{className:"things"},React.createElement("section",{className:"craft"},React.createElement(CardCraftSelector,{index:0,items:r,exceptFor:t.selections,onUpdate:this.onCardSelectionUpdate,readOnly:t.performing!==undefined&&t.performing!==null}),React.createElement(CardCraftSelector,{index:1,items:r,exceptFor:t.selections,onUpdate:this.onCardSelectionUpdate,readOnly:t.performing!==undefined&&t.performing!==null}),React.createElement(CardCraftSelector,{index:2,items:r,exceptFor:t.selections,onUpdate:this.onCardSelectionUpdate,readOnly:t.performing!==undefined&&t.performing!==null}),React.createElement("section",{className:"action"},t.performing!=="craft"&&React.createElement("a",{className:"actionCraft"+(t.performing||!t.selections||t.selections.filter(function(e){return!e}).length>0?" disabled":""),"data-action":"craft",href:"javascript:;",onClick:this.perform},"Craft"),t.performing==="craft"&&React.createElement(InlineLoader,null))),React.createElement("section",{className:"collectionALL"},n.map(function(e){return React.createElement("section",{key:e.key,className:"collection"},React.createElement(CardInfo,{card:e}),React.createElement("a",{className:"unibtn",href:window.context.uniswapSpawUrlTemplate.format(e.erc20Wrapper),target:"_blank"},"🦄swap"))}))),t.items&&t.items.length>0&&t.toggle==="farming"&&React.createElement(Farming,{sortedItems:n}),t.items&&t.items.length>0&&t.toggle==="redeem"&&React.createElement(Redeem,{onBack:this.toggleRedeem,sortedItems:n}))}});var InlineLoader=React.createClass({displayName:"InlineLoader",render:function(){return React.createElement("section",null,React.createElement("span",null,"Load 🦖"))}});var RedeemController = function (view) {
    var context = this;
    context.view = view;

    context.getBalance = async function getBalance() {
        var whereIsMyDragonEthItem = await window.newContract(window.context.IEthItemABI, window.getNetworkElement("whereIsMyDragonEthItemAddress"));
        return await window.blockchainCall(whereIsMyDragonEthItem.methods.balanceOf, window.walletAddress, window.getNetworkElement("unicornDragonItemID"));
    };

    context.redeem = async function redeem(amount) {
        var whereIsMyDragonEthItem = await window.newContract(window.context.IEthItemABI, window.getNetworkElement("whereIsMyDragonEthItemAddress"));
        var transaction = await window.blockchainCall(whereIsMyDragonEthItem.methods.safeTransferFrom, window.walletAddress, window.getNetworkElement("treasureAddress"), window.getNetworkElement("unicornDragonItemID"), amount, "0x");
        return transaction.transactionHash;
    };
};var Redeem=React.createClass({displayName:"Redeem",requiredScripts:["spa/index/cardInfo.jsx","spa/inlineLoader.jsx"],getDefaultSubscriptions:function(){return{"ethereum/ping":this.getBalance}},getBalance:function(){var t=this;t.setStateVar("balance",0),t.controller.getBalance().then(function(e){return t.setStateVar("balance",e)})},render:function(){function p(){h(!1);var e=parseInt(f),n=e;if(e<n)return alert("Insufficient balance");if(n<=0)return alert("Amount must be greater than 0");i(!0),t.controller.redeem(n).then(h).finally(function(){return i(!1)}).catch(function(e){return alert(e.message||e)})}var t=this,n=useState(this,!1),r=n[0],i=n[1],s=useState(this,1),o=s[0],u=s[1],a=useState(this,0,"balance"),f=a[0],l=useState(this,""),c=l[0],h=l[1];useEffect(this,function(){return t.getBalance()},[]),useEffect(this,function(){return c&&t.getBalance()},[c]);var d=parseInt(f),v=12.7*d;return React.createElement("div",{className:"RedeemDragon"},React.createElement("a",{className:"backtocards",href:"javascript:;",onClick:this.props.onBack},"x"),!c&&React.createElement("div",{className:"mainToSwap"},React.createElement("img",{src:"assets/img/treasure.gif"}),r&&React.createElement("div",null,"Redeeming"),!r&&React.createElement("a",{href:"javascript:;",onClick:p,className:"RedeemBTN"},"Redeem"),React.createElement("aside",null,"1 Dragon = 12.7 ETH"),React.createElement("aside",null,"You can redeem: ",v," ETH"),React.createElement("div",{className:"DragonSupply"},React.createElement("figure",null,React.createElement("img",{src:"assets/img/cardImages/199242316350403115624675989599876480538394016058.png"}),React.createElement("p",null,d)))),c&&React.createElement("div",{className:"SuccesRedeem"},React.createElement("h6",null,"Dear Dragon Hunter, ",React.createElement("br",null)," you have succesfully redeemed your portion of the treasury!"),React.createElement("a",{target:"_blank",href:window.getNetworkElement("etherscanURL")+"tx/"+c},"Transaction")))}});